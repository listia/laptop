#fancy_echo "Installing MySQL 5.5.30 ..."
#  if [ "$(brew tap | grep versions)" == "" ]; then
#    brew tap homebrew/versions
#  fi

#  brew_install_or_upgrade mysql55
#  brew link --force mysql55

fancy_echo "Installing MySQL5.6 ..."
  fancy_echo "Updating brew formula..."
  brew update
  if (ps -Af | grep -q "[m]ysql55" ) ; then
    fancy_echo "Found MySQL5.5 is running ... Attempting to stop it..."
    if [ -f ~/Library/LaunchAgents/homebrew.mxcl.mysql55.plist ]; then
      fancy_echo "Found the launchd file. Stop with lauchctl..."
      launchctl unload ~/Library/LaunchAgents/homebrew.mxcl.mysql55.plist
    else
      fancy_echo "launchd file not found. Stop with mysql.server"
      /usr/local/bin/mysql.server stop
    fi
  fi

  if ( mysql --version | grep -q "5.5" ); then
    if (brew remove https://gist.githubusercontent.com/ngan/f1e3268855262514a607/raw/beb171d376303d5e3397adca500d30834bab8b7a/mysql.rb || brew unlink mysql || brew unpin mysql); then
      fancy_echo "Removed MySQL5.5 Formula"
    fi
    mysqldata_need_update=1
  fi

  if (brew list | grep -q "mysql55"); then
    if (brew unlink mysql55 || brew unpin mysql55 || mysqldata_need_update=1); then
      fancy_echo "Removed MySQL5.5 from tap"
    fi
  fi

  if [ -f ~/Library/LaunchAgents/homebrew.mxcl.mysql55.plist ]; then
      fancy_echo "Attempt to unlink launchd file manully for MySQL55"
      unlink ~/Library/LaunchAgents/homebrew.mxcl.mysql55.plist
  fi

  # Update for people use MAC OS X Image
  # http://dev.mysql.com/doc/mysql-macosx-excerpt/5.1/en/macosx-installation-startupitem.html
  if [ -f /usr/local/mysql/bin/mysqld ]; then
    fancy_echo "Found an installation of MAC DMG. Try to stop it..."
    fancy_echo "Going to use sudo to stop mysqld. Please enter password..."
    if [ -d /Library/StartupItems/MySQLCOM ]; then
      sudo /Library/StartupItems/MySQLCOM/MySQLCOM stop
    else
      sudo /usr/local/mysql/bin/mysqld stop
    fi

    if [ -d /usr/local/mysql/data ]; then
      fancy_echo "Found /usr/local/mysql/data data dir. Migration this data folder..."
      fancy_echo "..."
      cp -rf /usr/local/mysql/data /usr/local/var/mysql
    fi
    fancy_echo "Removing old MYSQL start-up item. Please enter password..."
    sudo rm -rf /Library/StartupItems/MySQLCOM
  fi

  brew_install_or_upgrade mysql
  brew link mysql

  if [[ "$mysqldata_need_update" ]]; then
    fancy_echo "Upgrading data format to 5.6..."

    if [ -d /usr/local/var/mysql55 ]; then
      fancy_echo "Found /usr/local/var/mysql55 data dir. Migration this data folder..."
      cp -rf /usr/local/var/mysql /usr/local/var/mysql.backup
      fancy_echo "..."
      cp -rf /usr/local/var/mysql55 /usr/local/var/mysql
    fi

    fancy_echo "Starting mysql5.6..."
    brew_launchctl_restart mysql
    sleep 3
    fancy_echo "Upgrade data to 5.6 format"
    if mysql_upgrade; then
      echo "Data upgrade finished."
    else
      echo "Data is in 5.6 format. Ignore."
    fi

  fi

  brew pin mysql

